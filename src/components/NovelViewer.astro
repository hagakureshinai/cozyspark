---
// src/components/NovelViewer.astro
interface Props {
    title: string;
    workTitle: string;
    workLink: string;
    prevLink?: string;
    nextLink?: string;
    indexLink: string;
    isShortStory?: boolean; // 短編かどうか（Finのみ表示など）
}

const {
    title,
    workTitle,
    workLink,
    prevLink,
    nextLink,
    indexLink,
    isShortStory = false,
} = Astro.props;
---

<article>
    {
        /* 短編の場合はヘッダー（作品名・話数タイトル）を非表示にする（親側で表示しているため） */
    }
    {
        !isShortStory && (
            <header class="novel-header">
                <p class="work-title">
                    <a href={workLink}>{workTitle}</a>
                </p>
                <h1 class="episode-title">{title}</h1>
            </header>
        )
    }

    <div class="novel-content">
        <slot />
        {/* 次の話（nextLink）がない場合、または短編の場合に Fin. を表示 */}
        {(!nextLink || isShortStory) && <p class="fin">Fin.</p>}
    </div>

    <nav class="episode-navigation">
        <div class="nav-links">
            {
                prevLink ? (
                    <a href={prevLink} class="prev">
                        &laquo; 前の話へ
                    </a>
                ) : (
                    <span class="disabled" />
                )
            }

            <a href={indexLink} class="index">目次へ</a>

            {
                nextLink ? (
                    <a href={nextLink} class="next">
                        次の話へ &raquo;
                    </a>
                ) : (
                    <span class="disabled" />
                )
            }
        </div>
    </nav>
</article>

<style>
    .work-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .work-title a {
        color: #888;
        text-decoration: none;
    }
    .episode-title {
        font-size: 1.5rem;
        margin-top: 0;
        margin-bottom: 3rem;
        font-weight: normal;
    }

    .novel-content {
        line-height: 2;
        font-size: 1.1rem;
        margin-bottom: 2rem;
        white-space: pre-wrap;
    }

    /* Markdownの中の p タグを強制的に指定する */
    .novel-content :global(p) {
        margin-top: 0;
        margin-bottom: 2em; /* 段落の間隔 */
        text-indent: 1em; /* 全ての行の1文字目を字下げ */
    }

    /* 見出しの直後のpタグは字下げしない（組版ルール） */
    .novel-content :global(h2) + :global(p),
    .novel-content :global(h3) + :global(p) {
        text-indent: 0;
    }

    /* ルビの調整 */
    .novel-content :global(ruby) {
        ruby-align: center;
    }
    .novel-content :global(rt) {
        font-size: 0.6em;
    }

    /* フッターがナビに被らないよう、呼び出し元のLayoutで調整が必要だが、
     ここではコンポーネント自身が下部にマージンを持つことで安全策とする */
    /* note: Layout側で footer padding を調整するか、ここで body に margin を追加するのは難しい。
     Global CSS で .site-footer に padding-bottom を追加するか、
     このコンポーネントがマウントされたときにスタイルを注入する形になる。
     今回はシンプルに、このコンポーネントを使うページは Layout 側で footer スタイルが適用されることを期待する。
     （レイアウト側で :global(.site-footer) { padding-bottom: ... } を指定していたロジックは
       Layout.astro に移すか、global.css に書くのが適切）
  */

    /* エピソードナビゲーションを全デバイスで固定 */
    .episode-navigation {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 0.8rem 0; /* 上下余白を少しスリムに */
        background: rgba(253, 253, 253, 0.85);
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
        border-top: 1px solid #eee;
        z-index: 100;
    }

    .nav-links {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr; /* 画面を3等分 */
        align-items: center;
        max-width: var(--container-max-width);
        margin: 0 auto;
        padding: 0 var(--side-padding);
        box-sizing: border-box;
    }

    .nav-links > * {
        display: block;
    }

    .nav-links .prev,
    .nav-links .disabled:first-child {
        text-align: left;
    }

    .nav-links .index {
        text-align: center;
    }

    .nav-links .next,
    .nav-links .disabled:last-child {
        text-align: right;
    }

    .nav-links a {
        text-decoration: none;
        color: var(--text-color);
        font-size: 0.9rem;
        padding: 0.5rem 0;
        transition: opacity 0.2s;
    }

    .nav-links a:hover {
        opacity: 0.6;
    }

    @media (max-width: 768px) {
        .nav-links a {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
        }
    }

    .fin {
        text-align: center;
        margin: 5rem 0;
        font-size: 1.2rem;
        color: var(--text-color);
        text-indent: 0 !important;
        letter-spacing: 0.2rem;
        padding-left: 0.2rem; /* letter-spacingのバランス調整 */
    }
</style>
