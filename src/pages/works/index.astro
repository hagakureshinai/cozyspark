---
// src/pages/works/index.astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const allWorks = await getCollection('works');
const sortedWorks = allWorks.sort((a, b) => a.data.order - b.data.order);

const seriesWorks = sortedWorks.filter(work => work.data.category === 'series');
const singleWorks = sortedWorks.filter(work => work.data.category === 'single');
const ssWorks = sortedWorks.filter(work => work.data.category === 'ss');

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// IDから拡張子を削除するヘルパー関数
const getSlug = (id: string) => id.replace(/\.[^/.]+$/, "");

// ★★★ 【編集エリア】ここから ★★★
// 「初めての方はこちら」に表示したい作品の [ID]（ファイル名）と [見出し] を設定します。
// 例: src/content/works/observer_love.md なら 'observer_love' と書く
const pickupConfig = [
  { id: 'observer_cake', label: '＊年下攻め×クール美人受け 「観測者」シリーズ試し読み' },
  { id: 'beyond_border', label: '＊おじさま×おじさま' },
  { id: 'beyond_control', label: '＊えちえち' }
];
// ★★★ 【編集エリア】ここまで ★★★

// 設定に基づき、作品データと見出しをセットにする
const pickupWorks = pickupConfig
  .map(config => {
    const work = allWorks.find(w => getSlug(w.id) === config.id);
    if (!work) return null;
    return { ...work, pickupLabel: config.label }; // 作品データに見出しを合体させる
  })
  .filter((item): item is NonNullable<typeof item> => !!item);
---

<Layout title="Works - Cozy Spark">
  <header class="page-header">
    <h1>作品一覧</h1>
  </header>

  {/* --- 【追加】ピックアップ（初めての方はこちら）セクション --- */}
   {pickupWorks.length > 0 && (
    <section class="work-category pickup-section">
      <h2>初めての方へ｜オススメ作品</h2>
      
      <ul class="work-list">
        {pickupWorks.map(work => (
          <li class="work-item pickup-item">
            <div class="work-main">
              {/* オススメ理由の見出し */}
              <div class="pickup-label">{work.pickupLabel}</div>
              
              <div class="work-header">
                <a href={`${baseUrl}/works/${getSlug(work.id)}/`}>
                  <span class="work-title">{work.data.title}</span>
                </a>
              </div>
              {work.data.description && (
                <p class="work-description">{work.data.description}</p>
              )}
            </div>
          </li>
        ))}
      </ul>
    </section>
  )}

  {seriesWorks.length > 0 && (
    <section class="work-category">
    <div class="category-header-group">
      <h2>「観測者」シリーズ（長編・連作）</h2>
      <p class="category-info">大学生・秋吉悠也(20)×大学教員・藤堂圭(28)のシリーズ。</p>
    </div>

      <ul class="work-list">
        {seriesWorks.map(work => (
          <li class="work-item">
            <div class="work-main">
              <div class="work-header">
                <a href={`${baseUrl}/works/${getSlug(work.id)}/`}>
                  <span class="work-title">{work.data.title}</span>
                </a>
                <div class="work-badges">
                  {work.data.status === 'ongoing' ? (
                    <span class="badge-ongoing">連載中</span>
                  ) : (
                    <span class="badge-completed">完結済</span>
                  )}
                  {work.data.isUpdated && <span class="badge-updated">UP</span>}
                </div>

                {work.data.lastUpdated && (
                  <time class="work-date">
                    {work.data.lastUpdated.toLocaleDateString('ja-JP', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit'
                    }).replace(/\//g, '.')}
                  </time>
                )}
              </div>
              
              {work.data.description && (
                <p class="work-description">{work.data.description}</p>
              )}
            </div>

          </li>
        ))}
      </ul>
    </section>
  )}

  {singleWorks.length > 0 && (
    <section class="work-category">
      <div class="category-header-group">
        <h2>単発作品</h2>
        <p class="category-info">観測者シリーズ以外の、単独で読める作品をまとめています。すべて完結済みです。</p>
      </div>

      <ul class="work-list">
        {singleWorks.map(work => (
          <li class="work-item">
                        <div class="work-main">
              <div class="work-header">
                <a href={`${baseUrl}/works/${getSlug(work.id)}/`}>
                  <span class="work-title">{work.data.title}</span>
                </a>
                <div class="work-badges">
                  {work.data.status === 'ongoing' && <span class="badge-ongoing">連載中</span>}
                  {work.data.isUpdated && <span class="badge-updated">UP</span>}
                </div>
                {work.data.lastUpdated && (
                  <time class="work-date">
                    {work.data.lastUpdated.toLocaleDateString('ja-JP', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit'
                    }).replace(/\//g, '.')}
                  </time>
                )}
              </div>
              
              {work.data.description && (
                <p class="work-description">{work.data.description}</p>
              )}
            </div>

          </li>
        ))}
      </ul>
    </section>
  )}

  {ssWorks.length > 0 && (
    <section class="work-category">
    <div class="category-header-group">
      <h2>掌編小説</h2>
      <p class="category-info">Xで投稿した150～1000字のSS。すべて完結済みです。</p>
    </div>

      <ul class="work-list">
        {ssWorks.map(work => (
          <li class="work-item">
                        <div class="work-main">
              <div class="work-header">
                <a href={`${baseUrl}/works/${getSlug(work.id)}/`}>
                  <span class="work-title">{work.data.title}</span>
                </a>
                <div class="work-badges">
                  {work.data.isUpdated && <span class="badge-updated">UP</span>}
                </div>
              </div>
              
              {work.data.description && (
                <p class="work-description">{work.data.description}</p>
              )}
            </div>

            {work.data.lastUpdated && (
              <time class="work-date">
                {work.data.lastUpdated.toLocaleDateString('ja-JP', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit'
                }).replace(/\//g, '.')}
              </time>
            )}        
          </li>
        ))}
      </ul>
    </section>
  )}
</Layout>

<style>
  .page-header {
    margin-bottom: 3rem;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: normal;
    border-bottom: 1px solid var(--accent-color);
    padding-bottom: 0.5rem;
    margin-top: 1rem;
  }

  .pickup-section {
    padding: 1.5rem;
    border: 1px solid #E7D1D5;
    border-radius: 8px;
  }

  .pickup-item {
    margin-bottom: 2rem; /* 作品ごとの間隔を少し広げる */
  }

  .pickup-label {
    font-size: 0.85rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.2rem;
  }

  .work-category {
    margin-bottom: 3rem;
  }

  .category-header-group {
    background-color: #f4f4f4;
    border-left: 4px solid var(--accent-color);
    padding: 0.8rem 1rem;
    margin-bottom: 1.5rem;
    border-radius: 2px;
  }

  h2 {
    font-size: 1.1rem;
    font-weight: bold;
    color: #555;
    margin: 0; /* 周囲の余白をリセット */
    text-transform: uppercase;
    letter-spacing: 0.1em;
    background: none; /* 背景を消す */
    border: none;     /* 枠線を消す */
    padding: 0;      /* 余白を消す */
  }

  /* --- 説明文のスタイルを修正 --- */
  .category-info {
    font-size: 0.85rem;
    color: #777;
    margin: 0.3rem 0 0 0; /* 上に少しだけ隙間を作る */
  }

  .work-list {
    list-style: none;
    padding: 0;
  }

  .work-main {
    flex: 1;
  }

  .work-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.3rem;
    flex-wrap: wrap; /* 画面が狭い時に日付が下に落ちるように */
  }

  .work-item {
    margin-bottom: 1.5rem; /* 間隔を少し広げる */
    display: flex;
    align-items: flex-start; /* 上揃えに */
    padding-bottom: 1rem;
  }

  .work-item a {
    font-size: 1.1rem;
    font-weight: bold; /* タイトルを少し強調 */
  }

  .work-description {
    margin: 0;
    font-size: 0.9rem;
    color: #666;
    line-height: 1.5;
  }

  .work-date {
    font-size: 0.8rem;
    color: var(--accent-color);
    font-family: sans-serif;
    white-space: nowrap; /* 日付が途中で折れないように */
  }

  .work-badges {
    display: flex;
    gap: 0.4rem;
  }

  .badge-ongoing {
    font-size: 0.7rem;
    color: #fff;
    border: 1px solid #ccc;
    padding: 1px 6px;
    border-radius: 2px;
    background-color: #4F8FA8;
  }

  .badge-completed {
    font-size: 0.7rem;
    color: #fff;
    padding: 1px 6px;
    border-radius: 2px;
    background-color: #7FAF8F;
  }

    /* 【UPバッジのCSSを追加】 */
  .badge-updated {
    font-size: 0.7rem;
    font-weight: bold;
    color: #fff;
    background-color: #A03A3A; /* 赤系 */
    padding: 1px 6px;
    border-radius: 2px;
    line-height: 1.5; /* テキストの位置調整 */
  }
</style>