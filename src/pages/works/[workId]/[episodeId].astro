---
// src/pages/works/[workId]/[episodeId].astro
import { getCollection, render } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import NovelViewer from "../../../components/NovelViewer.astro";

export async function getStaticPaths() {
  const allEpisodes = await getCollection("episodes");
  const allWorks = await getCollection("works");

  // IDから拡張子を除いたファイル名を取得する安全な関数
  const getSlug = (id: string) => {
    return (
      id
        .split("/")
        .pop()
        ?.replace(/\.[^/.]+$/, "") || id
    );
  };

  return allEpisodes.map((episode) => {
    const workId = episode.data.workId;
    const episodeId = getSlug(episode.id);

    const workEpisodes = allEpisodes
      .filter((e) => e.data.workId === workId)
      .sort((a, b) => a.data.order - b.data.order);

    const currentIndex = workEpisodes.findIndex((e) => e.id === episode.id);

    const prevEpisode =
      currentIndex > 0 ? workEpisodes[currentIndex - 1] : null;
    const nextEpisode =
      currentIndex < workEpisodes.length - 1
        ? workEpisodes[currentIndex + 1]
        : null;

    const work = allWorks.find((w) => getSlug(w.id) === workId);

    return {
      params: {
        workId: workId,
        episodeId: episodeId,
      },
      props: {
        episode,
        work,
        prevId: prevEpisode ? getSlug(prevEpisode.id) : null,
        nextId: nextEpisode ? getSlug(nextEpisode.id) : null,
      },
    };
  });
}

const { episode, work, prevId, nextId } = Astro.props;
const { Content } = await render(episode);

// ★ SEO用の設定
const pageTitle = `${episode.data.title}（${work?.data.title}）`;
const pageDescription =
  episode.data.description ||
  `${work?.data.title} 第${episode.data.order}話：${episode.data.title}のページです。`;

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");
const workBasePath = `${baseUrl}/works/${episode.data.workId}`;
---

<Layout title={pageTitle} description={pageDescription} narrow={true}>
  <NovelViewer
    title={episode.data.title}
    workTitle={work?.data.title || ""}
    workLink={`${workBasePath}/`}
    prevLink={prevId ? `${workBasePath}/${prevId}/` : undefined}
    nextLink={nextId ? `${workBasePath}/${nextId}/` : undefined}
    indexLink={`${workBasePath}/`}
  >
    <Content />
  </NovelViewer>
</Layout>

<style>
  /* NovelViewerを使うので、ページ固有のスタイルは不要 */

  /* Layout側でfooterのpaddingが必要なので global で当てておく */
  :global(.site-footer) {
    padding-bottom: 6rem !important;
  }
</style>
