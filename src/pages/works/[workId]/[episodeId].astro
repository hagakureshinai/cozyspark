---
// src/pages/works/[workId]/[episodeId].astro
import { getCollection, render } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allEpisodes = await getCollection('episodes');
  const allWorks = await getCollection('works');

  // IDから拡張子を除いたファイル名を取得する安全な関数
  const getSlug = (id: string) => {
    return id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;
  };

  return allEpisodes.map((episode) => {
    const workId = episode.data.workId;
    const episodeId = getSlug(episode.id);
    
    const workEpisodes = allEpisodes
      .filter((e) => e.data.workId === workId)
      .sort((a, b) => a.data.order - b.data.order);

    const currentIndex = workEpisodes.findIndex((e) => e.id === episode.id);
    
    const prevEpisode = currentIndex > 0 ? workEpisodes[currentIndex - 1] : null;
    const nextEpisode = currentIndex < workEpisodes.length - 1 ? workEpisodes[currentIndex + 1] : null;

    const work = allWorks.find((w) => w.id === workId);

    return {
      params: { 
        workId: workId, 
        episodeId: episodeId 
      },
      props: { 
        episode, 
        work, 
        prevId: prevEpisode ? getSlug(prevEpisode.id) : null,
        nextId: nextEpisode ? getSlug(nextEpisode.id) : null,
      },
    };
  });
}

const { episode, work, prevId, nextId } = Astro.props;
const { Content } = await render(episode);

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");
---

<Layout title={`${episode.data.title} - ${work?.data.title}`}>
  <article class="novel-container">
    <header class="novel-header">
      <p class="work-title">
        <a href={`${baseUrl}/works/${episode.data.workId}/`}>{work?.data.title}</a>
      </p>
      <h1 class="episode-title">{episode.data.title}</h1>
    </header>

    <div class="novel-content">
      <Content />
    </div>

    <nav class="episode-navigation">
      <div class="nav-links">
        {prevId ? (
          <a href={`${baseUrl}/works/${episode.data.workId}/${prevId}/`} class="prev">
            &laquo; 前へ
          </a>
        ) : (
          <span class="disabled"></span>
        )}
        
        <a href={`${baseUrl}/works/${episode.data.workId}/`} class="index">目次</a>

        {nextId ? (
          <a href={`${baseUrl}/works/${episode.data.workId}/${nextId}/`} class="next">
            次へ &raquo;
          </a>
        ) : (
          <span class="disabled"></span>
        )}
      </div>
    </nav>
  </article>
</Layout>

<style>
  .novel-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  .work-title {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }
  .work-title a {
    color: #888;
    text-decoration: none;
  }
  .episode-title {
    font-size: 1.5rem;
    margin-top: 0;
    margin-bottom: 3rem;
    font-weight: normal;
  }
  
  .novel-content {
    line-height: 2;
    font-size: 1.1rem;
    margin-bottom: 5rem;
    white-space: pre-wrap; 
  }

  .episode-navigation {
    border-top: 1px solid #eee;
    padding-top: 2rem;
  }
  .nav-links {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .nav-links a {
    text-decoration: none;
    color: #333;
    padding: 0.5rem 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .nav-links a:hover {
    background: #f9f9f9;
  }
  .nav-links .index {
    border: none;
    color: #888;
  }
  .disabled {
    width: 80px; 
  }
</style>