---
// src/pages/works/[workId]/[episodeId].astro
import { getCollection, render } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allEpisodes = await getCollection('episodes');
  const allWorks = await getCollection('works');

  // IDから拡張子を除いたファイル名を取得する安全な関数
  const getSlug = (id: string) => {
    return id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;
  };

  return allEpisodes.map((episode) => {
    const workId = episode.data.workId;
    const episodeId = getSlug(episode.id);
    
    const workEpisodes = allEpisodes
      .filter((e) => e.data.workId === workId)
      .sort((a, b) => a.data.order - b.data.order);

    const currentIndex = workEpisodes.findIndex((e) => e.id === episode.id);
    
    const prevEpisode = currentIndex > 0 ? workEpisodes[currentIndex - 1] : null;
    const nextEpisode = currentIndex < workEpisodes.length - 1 ? workEpisodes[currentIndex + 1] : null;

    const work = allWorks.find((w) => getSlug(w.id) === workId);

    return {
      params: { 
        workId: workId, 
        episodeId: episodeId 
      },
      props: { 
        episode, 
        work, 
        prevId: prevEpisode ? getSlug(prevEpisode.id) : null,
        nextId: nextEpisode ? getSlug(nextEpisode.id) : null,
      },
    };
  });
}

const { episode, work, prevId, nextId } = Astro.props;
const { Content } = await render(episode);

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");
---

<Layout title={`Cozy Spark- ${work?.data.title} - ${episode.data.title}`}>
  <article>
    <header class="novel-header">
      <p class="work-title">
        <a href={`${baseUrl}/works/${episode.data.workId}/`}>{work?.data.title}</a>
      </p>
      <h1 class="episode-title">{episode.data.title}</h1>
    </header>

    <div class="novel-content">
      <Content />
    </div>

    <nav class="episode-navigation">
      <div class="nav-links">
        {prevId ? (
          <a href={`${baseUrl}/works/${episode.data.workId}/${prevId}/`} class="prev">
            &laquo; 前へ
          </a>
        ) : (
          <span class="disabled"></span>
        )}
        
        <a href={`${baseUrl}/works/${episode.data.workId}/`} class="index">目次</a>

        {nextId ? (
          <a href={`${baseUrl}/works/${episode.data.workId}/${nextId}/`} class="next">
            次へ &raquo;
          </a>
        ) : (
          <span class="disabled"></span>
        )}
      </div>
    </nav>
  </article>
</Layout>

<style>
  .work-title {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }
  .work-title a {
    color: #888;
    text-decoration: none;
  }
  .episode-title {
    font-size: 1.5rem;
    margin-top: 0;
    margin-bottom: 3rem;
    font-weight: normal;
  }
  
  .novel-content {
    line-height: 2;
    font-size: 1.1rem;
    margin-bottom: 5rem;
    white-space: pre-wrap; 
  }

  /* Layout.astroから移動した p タグのスタイル */
  .novel-content p {
    margin-top: 0;
    margin-bottom: 2.0em; /* 段落間隔 */
    text-indent: 1em; /* 行頭字下げ */
  }

  /* Layout.astroから移動した組版ルール */
  .novel-content h2 + p,
  .novel-content h3 + p {
    text-indent: 0;
  }

  .episode-navigation {
    margin-top: 3rem;
    padding: 1.5rem 0;
    border-top: 1px solid #eee;
  }

  .nav-links {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .nav-links a {
    text-decoration: none;
    color: var(--text-color);
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
    background: #fff;
    transition: background 0.2s;
  }

  .nav-links a:hover {
    background: #f9f9f9;
  }
  .nav-links .index {
    border: none;
    color: #888;
  }
  .disabled {
    width: 80px; 
  }

  /* スマホ表示（768px以下）での固定表示設定 */
  @media (max-width: 768px) {
    .episode-navigation {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      margin-top: 0; /* 固定なのでマージン不要 */
      padding: 0.8rem 1rem; /* 高さをスリムに */
      background: rgba(253, 253, 253, 0.85); /* ヘッダーより少し不透明度を上げて操作しやすく */
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border-top: 1px solid #eee;
      z-index: 100;
      box-sizing: border-box;
    }

    .nav-links {
      max-width: 500px; /* 広がりすぎないように */
      margin: 0 auto;
    }

    .nav-links a {
      font-size: 0.8rem; /* 文字を少し小さく */
      padding: 0.4rem 0.8rem;
      border: none; /* 枠線を消してスッキリさせる */
      background: transparent;
    }
    
    /* 本文がフッターに被らないよう、記事の末尾に余白を追加 */
    article {
      padding-bottom: 5rem;
    }
  }

</style>