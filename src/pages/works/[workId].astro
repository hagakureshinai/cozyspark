---
// src/pages/works/[workId].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allWorks = await getCollection('works');
  const allEpisodes = await getCollection('episodes');

  // IDから拡張子を除くヘルパー関数
  const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

  return allWorks.map((work) => {
    const workSlug = cleanId(work.id);

    // 作品内のエピソードを抽出（FrontmatterのworkIdと、作品データのファイル名を比較）
    const workEpisodes = allEpisodes
      .filter((episode) => {
        // エピソード側が持つ workId と、作品側のファイル名(slug)が一致するか確認
        return episode.data.workId === workSlug;
      })
      .sort((a, b) => a.data.order - b.data.order);

    return {
      params: { workId: workSlug }, // 拡張子なしのIDをURLにする
      props: { work, episodes: workEpisodes },
    };
  });
}

const { work, episodes } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// エピソード用にも同じ関数を用意
const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

// 【新規追加】最新エピソードのIDを取得
let latestEpisodeId: string | null = null;
if (episodes.length > 0) {
    // episodesは既にorder順にソートされているため、最後の要素が最新
    latestEpisodeId = cleanId(episodes[episodes.length - 1].id);
}

// work-headerからUPバッジを削除するため、work.data.isUpdatedを無効化
// work.data.isUpdatedがtrueかどうかを取得し、下のテンプレートで使用する
const shouldShowWorkUpdateBadge = work.data.isUpdated;
---

<Layout title={work.data.title}>
  <div class="work-detail-content">
    <header class="work-header">
      <h1 class="work-title">{work.data.title}</h1>
      <div class="work-meta">
        <!-- {/* UPバッジを追加 */} -->
        <!-- {work.data.isUpdated && <span class="badge-updated">UP</span>} -->
        <span class="category">{work.data.category}</span>
        <span class="status">{work.data.status === 'completed' ? '完結' : '連載中'}</span>
      </div>
    </header>

    <section class="episode-list-section">
      <h2 class="section-title">目次</h2>
      <ul class="episode-list">
        {episodes.map((episode) => {
          const episodeId = cleanId(episode.id);
          // 作品が更新フラグON かつ 現在のエピソードが最新話かどうか
          const isLatestAndUpdated = shouldShowWorkUpdateBadge && episodeId === latestEpisodeId;

          return (
            <li>
              <a href={`${baseUrl}/works/${cleanId(work.id)}/${episodeId}/`}>
                <span class="order">{episode.data.order}</span>
                <span class="title">{episode.data.title}</span>
                {/* エピソードにUPバッジを表示 */}
                {isLatestAndUpdated && <span class="badge-updated">UP</span>}
              </a>
            </li>
          );
        })}
      </ul>
      {episodes.length === 0 && <p>エピソードはまだありません。</p>}
    </section>

    <div class="back-to-top">
      <a href={`${baseUrl}/works/`}>&laquo; 作品一覧へ戻る</a>
    </div>
  </div>
</Layout>

<style>
  /* ページ固有のレイアウト上書き: Layout.astro で定義したカスタムプロパティを使用 */
  /* `:global` を使用して .content-area に影響を与える */
  :global(.content-area) {
    --content-max-width: 700px; /* このページでは 700px に設定 */
  }

  .work-header {
    margin-bottom: 3rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 2rem;
  }
  .work-title {
    font-size: 2rem;
    font-weight: normal;
    margin-bottom: 1rem;
  }
  .work-meta {
    font-size: 0.9rem;
    color: #888;
  }
  .work-meta span {
    margin-right: 1rem;
  }

  .section-title {
    font-size: 1.2rem;
    font-weight: normal;
    color: #666;
    margin-bottom: 1.5rem;
  }
  .episode-list {
    list-style: none;
    padding: 0;
  }
  .episode-list li {
    border-bottom: 1px dashed #eee;
  }
  .episode-list a {
    display: flex;
    padding: 1rem 0;
    text-decoration: none;
    color: #333;
    transition: color 0.2s;
    align-items: center; /* UPバッジとの縦位置を合わせるために追加 */
  }

  .episode-list a:hover {
    color: var(--accent-color);
  }

  .episode-list .order {
    width: 3rem;
    color: #ccc;
  }
  
  /* 【バッジのCSS調整】リンクの中に配置し、文字サイズに合わせて調整 */
  .badge-updated {
    font-size: 0.7rem; 
    font-weight: bold;
    color: #fff;
    background-color: #A03A3A; 
    padding: 1px 6px;
    border-radius: 2px;
    line-height: 1.5; 
    margin-left: 1rem; /* タイトルとの間にスペースを確保 */
  }
  
  .back-to-top {
    margin-top: 5rem;
    text-align: center;
  }
  .back-to-top a {
    text-decoration: none;
    color: #888;
    font-size: 0.9rem;
  }
</style>