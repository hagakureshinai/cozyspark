---
// src/pages/works/[workId].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allWorks = await getCollection('works');
  const allEpisodes = await getCollection('episodes');

  // IDから拡張子を除くヘルパー関数
  const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

  return allWorks.map((work) => {
    const workSlug = cleanId(work.id);

    // 作品内のエピソードを抽出（FrontmatterのworkIdと、作品データのファイル名を比較）
    const workEpisodes = allEpisodes
      .filter((episode) => {
        // エピソード側が持つ workId と、作品側のファイル名(slug)が一致するか確認
        return episode.data.workId === workSlug;
      })
      .sort((a, b) => a.data.order - b.data.order);

    return {
      params: { workId: workSlug }, // 拡張子なしのIDをURLにする
      props: { work, episodes: workEpisodes },
    };
  });
}

const { work, episodes } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// エピソード用にも同じ関数を用意
const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

// 【新規追加】最新エピソードのIDを取得
let latestEpisodeId: string | null = null;
if (episodes.length > 0) {
    // episodesは既にorder順にソートされているため、最後の要素が最新
    latestEpisodeId = cleanId(episodes[episodes.length - 1].id);
}

// work-headerからUPバッジを削除するため、work.data.isUpdatedを無効化
// work.data.isUpdatedがtrueかどうかを取得し、下のテンプレートで使用する
const shouldShowWorkUpdateBadge = work.data.isUpdated;

// カテゴリ名の変換マップ
const categoryNames = {
  'series': '観測者シリーズ',
  'single': '単発作品',
  'ss': '掌編小説'
};
---

<Layout title={`Cozy Spark - ${work.data.title} - 目次 `}>
  <div class="work-detail-content">
    <header class="work-header">
      <h1 class="work-title">{work.data.title}</h1>

      {/* ★作品一覧と同じ「あらすじ」を追加 */}
      {work.data.description && (
        <p class="work-description">{work.data.description}</p>
      )}

      <div class="work-meta">
        <span class="category">{categoryNames[work.data.category]}</span>
        {/* ★一覧ページと合わせたバッジ形式に変更 */}
        {work.data.status === 'ongoing' ? (
          <span class="badge-ongoing">連載中</span>
        ) : (
          <span class="badge-completed">完結済</span>
        )}

        {/* ★最終更新日も表示 */}
        {work.data.lastUpdated && (
          <time class="work-date">
            最終更新：{work.data.lastUpdated.toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            }).replace(/\//g, '.')}
          </time>
        )}
      </div>
    </header>

    <section class="episode-list-section">
      <h2 class="section-title">目次</h2>
      <ul class="episode-list">
        {episodes.map((episode) => {
          const episodeId = cleanId(episode.id);
          // 作品が更新フラグON かつ 現在のエピソードが最新話かどうか
          const isLatestAndUpdated = shouldShowWorkUpdateBadge && episodeId === latestEpisodeId;

          return (
            <li>
              <a href={`${baseUrl}/works/${cleanId(work.id)}/${episodeId}/`}>
                <div class="episode-info-container">
                  <div class="episode-main">
                    <span class="title">{episode.data.title}</span>
                    {isLatestAndUpdated && <span class="badge-updated">UP</span>}
                  </div>
                  
                  {episode.data.description && (
                    <span class="episode-description">{episode.data.description}</span>
                  )}
                </div>
              </a>
            </li>
          );
        })}
      </ul>
      {episodes.length === 0 && <p>エピソードはまだありません。</p>}
    </section>

  </div>
</Layout>

<style>
  .work-header {
    margin-bottom: 3rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 2rem;
  }
  .work-title {
    font-size: 2rem;
    font-weight: normal;
    margin-bottom: 1rem;
  }
  .work-meta {
    font-size: 0.9rem;
    color: #888;
    /* 要素が入り切らない時に折り返せるようにする */
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.8rem; /* 要素間の隙間 */
  }

  /* --- ★スマホ表示用の調整 --- */
  @media (max-width: 768px) {
    .work-date {
      flex-basis: 100%; /* ★幅を100%にして強制的に改行させる */
      margin-top: 0.2rem; /* 上の要素との微調整 */
    }
  }

  .section-title {
    font-size: 1.2rem;
    font-weight: normal;
    color: #666;
    margin-bottom: 1.5rem;
  }
  .episode-list {
    list-style: none;
    padding: 0;
  }
  .episode-list li {
    border-bottom: 1px dashed #eee;
  }

  .episode-list a {
    display: flex;
    padding: 1rem 0;
    align-items: center;
    font-size: 1.1rem;
    font-weight: bold;
    /* ★ hover時にマーカーまで下線が引かれないように調整 */
    text-decoration: none; 
  }

  /* ★ タイトル部分だけに下線を引く設定に変更 */
  .episode-list a:hover .title {
    text-decoration: underline;
  }

  .episode-list .title {
    display: flex;
    align-items: center;
  }

  /* ★ 行頭のマーカーを追加 */
  .episode-list .title::before {
    content: ""; /* 文字ではなく図形にする場合 */
    display: inline-block;
    width: 4px;   /* マーカーの幅 */
    height: 1.2rem; /* マーカーの高さ */
    background-color: var(--accent-color); /* マーカーの色（サイトのアクセント色） */
    margin-right: 1rem; /* タイトルとの距離 */
    border-radius: 2px; /* 少し角を丸める */
    opacity: 0.5; /* 少し透かして上品に */
  }

  /* ★ 新しく追加：タイトルとあらすじを包むコンテナ */
  .episode-info-container {
    display: flex;
    flex-direction: row;    /* デフォルト（PC）は横並び */
    align-items: center;  /* ★上下中央で揃える */
    gap: 1.5rem;            /* タイトルとあらすじの間隔 */
    width: 100%;
  }

  .episode-main {
    display: flex;
    align-items: center;
    flex-shrink: 0; /* タイトルが潰れないように固定 */
  }

  /* ★ あらすじのスタイル */
  .episode-description {
    font-size: 0.85rem;
    font-weight: normal; /* あらすじは細字に */
    color: #777;        /* 少し薄い色に */
    line-height: 1.4;
  }

  /* --- ★ スマホ表示用の切り替え（画面幅が768px以下の場合） --- */
  @media (max-width: 768px) {
    .episode-info-container {
      flex-direction: column; /* 縦並びに変更 */
      align-items: flex-start;
      gap: 0.3rem;            /* 縦の隙間を狭く */
    }
    
    .episode-description {
        padding-left: 1.4rem; /* 前に付けたマーカーの分だけ少し右に寄せる */
    }
  }
  
  /* 【バッジのCSS調整】リンクの中に配置し、文字サイズに合わせて調整 */
  .badge-updated {
    font-size: 0.7rem; 
    font-weight: bold;
    color: #fff;
    background-color: #A03A3A; 
    padding: 1px 6px;
    border-radius: 2px;
    line-height: 1.5; 
    margin-left: 1rem; /* タイトルとの間にスペースを確保 */
  }
  
  .back-to-top {
    margin-top: 5rem;
    text-align: center;
  }

</style>