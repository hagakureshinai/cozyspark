---
// src/pages/works/[workId].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allWorks = await getCollection('works');
  const allEpisodes = await getCollection('episodes');

  // IDから拡張子を除くヘルパー関数
  const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

  return allWorks.map((work) => {
    const workSlug = cleanId(work.id);

    // 作品内のエピソードを抽出（FrontmatterのworkIdと、作品データのファイル名を比較）
    const workEpisodes = allEpisodes
      .filter((episode) => {
        // エピソード側が持つ workId と、作品側のファイル名(slug)が一致するか確認
        return episode.data.workId === workSlug;
      })
      .sort((a, b) => a.data.order - b.data.order);

    return {
      params: { workId: workSlug }, // 拡張子なしのIDをURLにする
      props: { work, episodes: workEpisodes },
    };
  });
}

const { work, episodes } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// エピソード用にも同じ関数を用意
const cleanId = (id: string) => id.split('/').pop()?.replace(/\.[^/.]+$/, "") || id;

// 【新規追加】最新エピソードのIDを取得
let latestEpisodeId: string | null = null;
if (episodes.length > 0) {
    // episodesは既にorder順にソートされているため、最後の要素が最新
    latestEpisodeId = cleanId(episodes[episodes.length - 1].id);
}

// work-headerからUPバッジを削除するため、work.data.isUpdatedを無効化
// work.data.isUpdatedがtrueかどうかを取得し、下のテンプレートで使用する
const shouldShowWorkUpdateBadge = work.data.isUpdated;

// カテゴリ名の変換マップ
const categoryNames = {
  'series': '観測者シリーズ',
  'single': '単発作品',
  'ss': '掌編小説'
};
---

<Layout title={`Cozy Spark - ${work.data.title} - 目次 `}>
  <div class="work-detail-content">
    <header class="work-header">
      <h1 class="work-title">{work.data.title}</h1>

      {/* ★作品一覧と同じ「あらすじ」を追加 */}
      {work.data.description && (
        <p class="work-description">{work.data.description}</p>
      )}

      <div class="work-meta">
        <span class="category">{categoryNames[work.data.category]}</span>
        {/* ★一覧ページと合わせたバッジ形式に変更 */}
        {work.data.status === 'ongoing' ? (
          <span class="badge-ongoing">連載中</span>
        ) : (
          <span class="badge-completed">完結済</span>
        )}

        {/* ★最終更新日も表示 */}
        {work.data.lastUpdated && (
          <time class="work-date">
            最終更新：{work.data.lastUpdated.toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            }).replace(/\//g, '.')}
          </time>
        )}
      </div>
    </header>

    <section class="episode-list-section">
      <h2 class="section-title">目次</h2>
      <ul class="episode-list">
        {episodes.map((episode) => {
          const episodeId = cleanId(episode.id);
          const isLatestAndUpdated = shouldShowWorkUpdateBadge && episodeId === latestEpisodeId;

          return (
            <li>
              <a href={`${baseUrl}/works/${cleanId(work.id)}/${episodeId}/`}>
                <div class="episode-info-container">
                  {/* 左側：タイトルとUPバッジ */}
                  <div class="episode-main">
                    <span class="title">{episode.data.title}</span>
                    {isLatestAndUpdated && <span class="badge-updated">UP</span>}
                  </div>
                  
                  {/* 右側（スマホでは下）：文字数とあらすじ */}
                  {(episode.data.wordCount || episode.data.description) && (
                    <div class="episode-details">
                      {episode.data.wordCount && (
                        <span class="word-count">{episode.data.wordCount}</span>
                      )}
                      {episode.data.description && (
                        <span class="episode-description">{episode.data.description}</span>
                      )}
                    </div>
                  )}
                </div>
              </a>
            </li>
          );
        })}
      </ul>
      {episodes.length === 0 && <p>エピソードはまだありません。</p>}
    </section>

</Layout>

<style>
  /* --- 1. 作品ヘッダーエリア --- */
  .work-header {
    margin-bottom: 3rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 2rem;
  }
  .work-title {
    font-size: 2rem;
    font-weight: normal;
    margin-bottom: 1rem;
  }
  .work-description {
    margin-bottom: 1.5rem;
    line-height: 1.6;
    color: #444;
  }
  .work-meta {
    font-size: 0.9rem;
    color: #888;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.8rem;
  }
  /* 作品ステータスバッジ */
  .badge-ongoing, .badge-completed {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  .badge-ongoing { background: #4F8FA8; color: #fff; }
  .badge-completed { background: #7FAF8F; color: #fff; }

  /* --- 2. 目次リストエリア --- */
  .section-title {
    font-size: 1.2rem;
    font-weight: normal;
    color: #666;
    margin-bottom: 1.5rem;
  }
  .episode-list {
    list-style: none;
    padding: 0;
  }
  .episode-list li {
    border-bottom: 1px dashed #eee;
  }
  .episode-list a {
    display: block; /* 領域全体をリンクに */
    padding: 1rem 0;
    text-decoration: none;
  }
  .episode-list a:hover .title {
    text-decoration: underline;
  }

  /* タイトル・文字数・あらすじを包むコンテナ（PCでは横並び） */
  .episode-info-container {
    display: flex;
    align-items: center; 
    gap: 1.5rem;
    width: 100%;
  }

  /* タイトル部分 */
  .episode-main {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .episode-main .title {
    font-size: 1.1rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    color: var(--link-color);
  }
  /* 行頭のマーカー */
  .episode-main .title::before {
    content: "";
    display: inline-block;
    width: 4px;
    height: 1.2rem;
    background-color: var(--accent-color);
    margin-right: 1rem;
    border-radius: 2px;
    opacity: 0.5;
  }

  /* 文字数とあらすじのセット */
  .episode-details {
    display: flex;
    gap: 1rem;
    align-items: baseline;
    font-size: 0.85rem;
    color: #777;
  }
  .word-count {
    flex-shrink: 0;
    white-space: nowrap;
  }
  .episode-description {
    line-height: 1.4;
  }

  /* UPバッジ */
  .badge-updated {
    font-size: 0.7rem;
    font-weight: bold;
    color: #fff;
    background-color: #D4A017;
    padding: 1px 6px;
    border-radius: 2px;
    margin-left: 0.8rem;
  }

  .back-to-top {
    margin-top: 5rem;
    text-align: center;
  }

  /* --- 3. スマホ表示調整 (768px以下) --- */
  @media (max-width: 768px) {
    /* ヘッダーの日付を改行 */
    .work-date {
      flex-basis: 100%;
      margin-top: 0.2rem;
    }

    /* 目次を縦並びに（タイトル / 文字数 / あらすじ の3段） */
    .episode-info-container {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.3rem;
    }
    .episode-details {
      flex-direction: column;
      gap: 0.2rem;
      padding-left: 1.4rem; /* マーカーの分だけ字下げ */
    }
  }
</style>